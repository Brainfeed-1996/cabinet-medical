# Configuration Apache pour le cabinet médical
ServerName localhost

### AJOUT CRITIQUE : Chargement du module MPM (cause principale du crash)
LoadModule mpm_prefork_module modules/mod_mpm_prefork.so
<IfModule mpm_prefork_module>
    StartServers            2
    MinSpareServers         2
    MaxSpareServers         5
</IfModule>

# Configuration des répertoires (adapté pour Railway)
<Directory "/var/www/html">
    Options -Indexes +FollowSymLinks  # Désactive l'indexing pour la sécurité
    AllowOverride All
    Require all granted
    FallbackResource /index.php      # Redirection générique pour les frameworks PHP
</Directory>

# Configuration du répertoire public (spécifique à Railway)
<Directory "/var/www/html/public">
    Options -Indexes +FollowSymLinks
    AllowOverride All
    Require all granted
    
    RewriteEngine On
    RewriteBase /
    
    # Règles de réécriture optimisées
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteRule ^(.*)$ index.php [QSA,L]
</Directory>

# Configuration PHP (essentiel pour Railway)
<FilesMatch \.php$>
    SetHandler "proxy:unix:/tmp/php-fpm.sock|fcgi://localhost"
</FilesMatch>

### AJOUT SPÉCIFIQUE RAILWAY : Variables d'environnement sécurisées
<IfModule mod_env.c>
    # Utilisez les variables Railway MYSQL* si DB_* non définies
    SetEnv DB_HOST "${DB_HOST:-$MYSQLHOST}"
    SetEnv DB_NAME "${DB_NAME:-$MYSQLDATABASE}"
    SetEnv DB_USER "${DB_USER:-$MYSQLUSER}"
    SetEnv DB_PASS "${DB_PASS:-$MYSQLPASSWORD}"
</IfModule>

# Configuration des logs (adapté aux conteneurs Docker)
ErrorLog "/dev/stderr"
CustomLog "/dev/stdout" combined
LogLevel warn

# Configuration de la sécurité (renforcée)
<IfModule mod_headers.c>
    Header always set Content-Security-Policy "default-src 'self'"
    Header set X-Content-Type-Options "nosniff"
    Header set X-XSS-Protection "1; mode=block"
    Header set X-Frame-Options "DENY"
    Header set Referrer-Policy "strict-origin-when-cross-origin"
    Header unset Server
</IfModule>

# Gestion des erreurs (production)
php_flag display_errors off
php_flag log_errors on
php_value error_log "/dev/stderr"
php_value error_reporting 22527  # E_ALL & ~E_DEPRECATED & ~E_STRICT